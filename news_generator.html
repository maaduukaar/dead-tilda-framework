<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- Генератор Новостей v.4.2 -->
    <meta charset="UTF-8">
    <title>Генератор Новостей</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        #template-container, #news-page-template, #main-page-template {
            height: 200px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-8 rounded-2xl shadow-lg">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Генератор новостных страниц</h1>
                <p class="text-gray-500 mt-2">Заполните поля ниже, чтобы создать HTML-файл для новости.</p>
            </div>
            
            <form id="news-form" class="space-y-6">
                <!-- Поля для ввода данных -->
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Заголовок</label>
                    <input type="text" id="title" name="title" required class="block w-full px-4 py-3 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>

                <div>
                    <label for="page_url" class="block text-sm font-medium text-gray-700 mb-1">Ссылка на новость (для имени файла и URL)</label>
                    <input type="url" id="page_url" name="page_url" required placeholder="Авто-генерация из заголовка..." class="block w-full px-4 py-3 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-1">Дата</label>
                        <input type="text" id="date" name="date" required placeholder="ДД.ММ.ГГГГ" class="block w-full px-4 py-3 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                     <div>
                        <label for="image_url" class="block text-sm font-medium text-gray-700 mb-1">Ссылка на изображение</label>
                        <input type="text" id="image_url" name="image_url" required placeholder="Авто-генерация из заголовка..." class="block w-full px-4 py-3 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                </div>
               
                <div>
                    <label for="news_text" class="block text-sm font-medium text-gray-700 mb-1">Текст новости (каждый абзац с новой строки)</label>
                    <textarea id="news_text" name="news_text" rows="8" required class="block w-full px-4 py-3 bg-gray-100 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
                </div>

                <!-- Поле для вставки шаблона -->
                <div>
                    <label for="template-container" class="block text-sm font-medium text-gray-700 mb-1">HTML-шаблон страницы одной новости (с плейсхолдерами)</label>
                    <textarea id="template-container" class="block w-full px-4 py-3 bg-gray-900 text-green-400 font-mono text-xs border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Вставьте сюда код вашего шаблона с плейсхолдерами...">


                    </textarea>
                </div>
                
                <!-- Поле для кода страницы /news -->
                <div>
                    <label for="news-page-template" class="block text-sm font-medium text-gray-700 mb-1">Код страницы /news (с комментарием)</label>
                    <textarea id="news-page-template" class="block w-full px-4 py-3 bg-gray-900 text-green-400 font-mono text-xs border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Вставьте сюда код страницы /news с комментариями..."></textarea>
                </div>
                
                <!-- Поле для кода главной страницы -->
                <div>
                    <label for="main-page-template" class="block text-sm font-medium text-gray-700 mb-1">Код главной страницы (с комментарием)</label>
                    <textarea id="main-page-template" class="block w-full px-4 py-3 bg-gray-900 text-green-400 font-mono text-xs border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Вставьте сюда код главной страницы с комментариями..."></textarea>
                </div>
                
                <div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out shadow-md">
                        Сгенерировать и скачать HTML
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // --- Утилиты ---
        function transliterate(text) {
            const rus = "абвгдеёжзийклмнопрстуфхцчшщъыьэюя ".split("");
            const lat = "a,b,v,g,d,e,yo,zh,z,i,y,k,l,m,n,o,p,r,s,t,u,f,kh,ts,ch,sh,shch,,y,,e,yu,ya,-".split(",");
            let result = "";
            for (let i = 0; i < text.length; i++) {
                const char = text[i].toLowerCase();
                const index = rus.indexOf(char);
                if (index !== -1) {
                    result += lat[index];
                } else {
                    result += char.match(/[a-z0-9-]/) ? char : '';
                }
            }
            return result.replace(/-+/g, '-').replace(/^-|-$/g, '');
        }

        // --- Инициализация полей ---
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('date');
            const titleInput = document.getElementById('title');
            const pageUrlInput = document.getElementById('page_url');
            const imageUrlInput = document.getElementById('image_url');

            // 1. Установить сегодняшнюю дату по умолчанию
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            dateInput.value = `${day}.${month}.${year}`;

            // Выделять дату по клику/фокусу
            dateInput.addEventListener('focus', () => dateInput.select());

            // 2 & 3. Автогенерация ссылок из заголовка
            titleInput.addEventListener('input', () => {
                const titleValue = titleInput.value;
                if (!titleValue) return;
                
                // Генерировать ссылку на новость из первых 5 слов, если поле пустое
                if (pageUrlInput.value.trim() === '') {
                    const firstFiveWords = titleValue.split(' ').slice(0, 5).join(' ');
                    const slug = transliterate(firstFiveWords);
                    pageUrlInput.value = `https://r7-office.ru/news/tpost/${slug}`;
                }
                
                // Генерировать имя файла изображения из первых 3 слов, если поле пустое
                if (imageUrlInput.value.trim() === '') {
                    const firstThreeWords = titleValue.split(' ').slice(0, 3).join(' ');
                    const imageSlug = transliterate(firstThreeWords);
                    imageUrlInput.value = `${imageSlug}.jpg`;
                }
            });
        });

        // --- Основная логика генерации ---
        document.getElementById('news-form').addEventListener('submit', function(event) {
            event.preventDefault();

            // 1. Сбор данных из формы
            const pageUrl = document.getElementById('page_url').value;
            const dateStr = document.getElementById('date').value;
            const titleStr = document.getElementById('title').value;
            const imageUrl = document.getElementById('image_url').value;
            const newsText = document.getElementById('news_text').value;
            let templateHTML = document.getElementById('template-container').value;
            const newsPageTemplate = document.getElementById('news-page-template').value;
            const mainPageTemplate = document.getElementById('main-page-template').value;

            // 2. Проверка, вставлен ли шаблон
            if (templateHTML.trim() === '') {
                alert('Пожалуйста, вставьте HTML-код вашего шаблона в соответствующее поле.');
                return;
            }
            
            // 3. Подготовка имени файла и полного URL
            let fileName = 'news.html';
            let fileBaseName = 'news';
             if (pageUrl) {
                try {
                    const url = new URL(pageUrl);
                    const pathParts = url.pathname.split('/').filter(p => p);
                    if (pathParts.length > 0) {
                        fileBaseName = pathParts[pathParts.length - 1];
                        fileName = fileBaseName + '.html';
                    }
                } catch (e) {
                    console.error("Неверный URL страницы, используется fallback:", e);
                    const pathParts = pageUrl.split('/').filter(p => p);
                     if (pathParts.length > 0) {
                         fileBaseName = pathParts[pathParts.length - 1].split('?')[0];
                         fileName = fileBaseName + '.html';
                    }
                }
            }
            const fullNewsUrl = 'https://r7-office.ru/news/tpost/' + fileBaseName;
            
            // 4. Подготовка остального контента
            let imageName = '';
            // Проверяем, является ли значение в поле URL или просто именем файла
            if (imageUrl.startsWith('http')) {
                try {
                    const url = new URL(imageUrl);
                    imageName = url.pathname.split('/').pop();
                } catch (e) {
                    console.error("Неверный URL изображения, используется fallback:", e);
                    imageName = imageUrl.split('/').pop().split('?')[0];
                }
            } else {
                // Если это не URL, считаем, что это уже готовое имя файла
                imageName = imageUrl;
            }

            // 5. Использование абсолютного пути
            const finalImageSrc = `/images/news/${imageName}`;

            const paragraphs = newsText.trim().split(/\r?\n/).map(p => p.trim()).filter(p => p);
            let newsContentHTML = '';
            let firstParagraphText = '';
            if (paragraphs.length > 0) {
                firstParagraphText = paragraphs[0];
                newsContentHTML += `<h3>${firstParagraphText}</h3><br>`;
                for (let i = 1; i < paragraphs.length; i++) {
                    newsContentHTML += `<p>${paragraphs[i]}</p>`;
                }
            }
            
            // 6. Замена плейсхолдеров в основном шаблоне
            let finalHtml = templateHTML
                .replace(/{{URL}}/g, fullNewsUrl)
                .replace(/{{TITLE}}/g, titleStr)
                .replace(/{{H2_TITLE}}/g, titleStr)
                .replace(/{{DESCRIPTION}}/g, firstParagraphText)
                .replace(/{{NEWS_DATE}}/g, dateStr)
                .replace(/{{IMAGE_SRC}}/g, finalImageSrc)
                .replace(/{{NEWS_CONTENT}}/g, newsContentHTML);

            // 7. Создание и скачивание файла
            const blob = new Blob([finalHtml], { type: 'text/html;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);

            // Обработка шаблона страницы /news
            if (newsPageTemplate.trim() !== '') {
                // Шаблон для вставки новой новости
                const newsItemTemplate = `
              <!-- Место для новой новости. Скрипт -->

              <!-- {{TITLE}} {{NEWS_DATE}}. Начало-->
              <li
                class="js-feed-post t-feed__post t-item t-width t-feed__grid-col t-col t-col_4 t-align_left"
                data-post-uid="89nmunc9v1"
              >
                  <div class="t-feed__col-grid__post-wrapper">
                    <div
                      class="t-feed__post-imgwrapper t-feed__post-imgwrapper_beforetitle"
                      style="aspect-ratio: 1.8"
                    >
                      <div class="t-feed__post-label-wrapper"></div>
                      <div
                        class="t-feed__post-bgimg t-bgimg loaded"
                        bgimgfield="fe_img__89nmunc9v1"
                        data-original="{{IMAGE_SRC}}"
                        style="
                          background-image: url('{{IMAGE_SRC}}');
                        "
                        src=""
                      ></div>
                    </div>
                    <div
                      class="t-feed__col-grid__wrapper t-feed__col-grid__wrapper_align"
                    >
                      <div
                        class="t-feed__post-parts-date-row t-feed__post-parts-date-row_beforetitle"
                      >
                        <!--Дата-->
                        <span
                          class="js-feed-post-date t-feed__post-date t-uptitle t-uptitle_xs"
                          >{{NEWS_DATE}}</span
                        >
                      </div>
                      <div class="t-feed__textwrapper">
                        <div
                          class="js-feed-post-title t-feed__post-title t-name t-name_md"
                          field="fe_title__89nmunc9v1"
                          data-redactor-toolbar="no"
                        >
                        <a
                          href="{{URL}}"
                          class="t-feed__link js-feed-post-link"
                          role="button"
                          aria-haspopup="dialog"
                          target="_blank"
                        >
                          {{H2_TITLE}}
                        </a>
                        </div>
                        <!--Текст новости-->
                        <div
                          class="js-feed__post-descr t-feed__post-descr t-descr t-descr_xxs"
                          field="fe_descr__89nmunc9v1"
                          data-redactor-toolbar="no"
                        >
                          {{FIRST_PARAGRAPH}}
                        </div>
                      </div>
                    </div>
                  </div>
              </li>
              <!-- {{TITLE}} {{NEWS_DATE}} -->`;

                // Находим место для вставки новости и заменяем его
                let newsPageHTML = newsPageTemplate;
                const insertMarker = "<!-- Место для новой новости. Скрипт -->";
                
                if (newsPageHTML.includes(insertMarker)) {
                    // Заменяем плейсхолдеры в шаблоне новости
                    const filledNewsItem = newsItemTemplate
                        .replace(/{{URL}}/g, fullNewsUrl)
                        .replace(/{{TITLE}}/g, titleStr)
                        .replace(/{{H2_TITLE}}/g, titleStr)
                        .replace(/{{FIRST_PARAGRAPH}}/g, firstParagraphText)
                        .replace(/{{NEWS_DATE}}/g, dateStr)
                        .replace(/{{IMAGE_SRC}}/g, finalImageSrc);
                    
                    // Заменяем маркер вставки на новую новость
                    newsPageHTML = newsPageHTML.replace(insertMarker, filledNewsItem);
                    
                    // Создаем и скачиваем файл страницы новостей
                    const newsPageBlob = new Blob([newsPageHTML], { type: 'text/html;charset=utf-8' });
                    const newsPageLink = document.createElement('a');
                    newsPageLink.href = URL.createObjectURL(newsPageBlob);
                    newsPageLink.download = 'page10993303.html'; // название файла страницы /news
                    document.body.appendChild(newsPageLink);
                    newsPageLink.click();
                    document.body.removeChild(newsPageLink);
                    URL.revokeObjectURL(newsPageLink.href);
                }
            }

            // Обработка шаблона главной страницы
            if (mainPageTemplate.trim() !== '') {
                // Шаблон для вставки новой новости на главную страницу
                const mainPageNewsItemTemplate = `
                    <!-- Карточка новости. Начало -->
                    <li class="news1__li">
                        <!-- Ссылка на страницу новости -->
                        <a class="news1__b" href="{{URL}}" target="_blank">
                            <!-- Картинка -->
                            <span class="news1__img" style="background-image: url({{IMAGE_SRC}})"></span>
                            <span class="news1__b1">
                                <!-- Заголовок новости -->
                                <span class="news1__h3">{{TITLE}}</span>
                                <!-- Текст новости -->
                                <span class="news1__txt">{{FIRST_PARAGRAPH}}</span>
                                <!-- Дата новости -->
                                <span class="news1__date">{{NEWS_DATE}}</span>
                            </span>
                        </a>
                    </li>
                    <!-- Карточка новости. Конец -->`;

                // Заменяем плейсхолдеры в шаблоне новости
                const filledMainPageNewsItem = mainPageNewsItemTemplate
                    .replace(/{{URL}}/g, fullNewsUrl)
                    .replace(/{{TITLE}}/g, titleStr)
                    .replace(/{{FIRST_PARAGRAPH}}/g, firstParagraphText)
                    .replace(/{{NEWS_DATE}}/g, dateStr)
                    .replace(/{{IMAGE_SRC}}/g, finalImageSrc);

                // Создаем временный DOM-элемент для работы с шаблоном
                const tempDoc = document.implementation.createHTMLDocument();
                tempDoc.body.innerHTML = mainPageTemplate;

                // Находим блок новостей
                const newsUlBlock = tempDoc.querySelector('ul.news1__ul');

                if (newsUlBlock) {
                    // Находим все карточки новостей
                    const newsItems = newsUlBlock.querySelectorAll('li.news1__li');
                    
                    // Удаляем вторую карточку, если она есть
                    if (newsItems.length >= 2) {
                        newsItems[1].remove();
                    }
                    
                    // Создаем новую карточку
                    const newCardTemp = tempDoc.createElement('div');
                    newCardTemp.innerHTML = filledMainPageNewsItem.trim();
                    
                    // Вставляем новую карточку перед первой
                    if (newsItems.length > 0) {
                        newsUlBlock.insertBefore(newCardTemp.firstElementChild, newsItems[0]);
                    } else {
                        newsUlBlock.innerHTML += filledMainPageNewsItem;
                    }
                    
                    // Получаем обновленный HTML
                    const updatedMainPageHTML = tempDoc.body.innerHTML;
                    
                    // Создаем и скачиваем файл главной страницы
                    const mainPageBlob = new Blob([updatedMainPageHTML], { type: 'text/html;charset=utf-8' });
                    const mainPageLink = document.createElement('a');
                    mainPageLink.href = URL.createObjectURL(mainPageBlob);
                    mainPageLink.download = 'page53301905.html';
                    document.body.appendChild(mainPageLink);
                    mainPageLink.click();
                    document.body.removeChild(mainPageLink);
                    URL.revokeObjectURL(mainPageLink.href);
                }
            }

            // 8. Сброс полей
            document.getElementById('page_url').value = '';
            document.getElementById('image_url').value = '';
            document.getElementById('title').value = '';
            document.getElementById('news_text').value = '';
            
            // Возвращаем сегодняшнюю дату после сброса
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            document.getElementById('date').value = `${day}.${month}.${year}`;
        });
    </script>
</body>
</html>
